---
sidebar: sidebar 
permalink: proxmox/proxmox-ontap.html 
keywords: netapp, proxmox, proxmox ve, all-flash, nfs, iscsi, ontap, storage, aff 
summary: 'Le stockage partagé dans Proxmox Virtual Environment (VE) réduit le temps de migration en direct des machines virtuelles et constitue une meilleure cible pour les sauvegardes et les modèles cohérents dans l"ensemble de l"environnement.  Le stockage ONTAP peut répondre aux besoins des environnements hôtes Proxmox VE ainsi qu"aux demandes de stockage de fichiers invités, de blocs et d"objets.' 
---
= Provisionner le stockage ONTAP pour l'environnement virtuel Proxmox
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Configurez le stockage ONTAP avec Proxmox Virtual Environment (VE) à l'aide des protocoles NAS, SAN et SMB/CIFS.  Le stockage partagé dans Proxmox VE réduit le temps de migration des machines virtuelles en direct et fournit une meilleure cible pour la sauvegarde et des modèles cohérents dans l'ensemble de l'environnement.

Les hôtes Proxmox VE doivent disposer d'interfaces FC, Ethernet ou autres prises en charge câblées aux commutateurs et disposer d'une communication avec les interfaces logiques ONTAP .  Vérifiez toujours https://mysupport.netapp.com/matrix/#welcome["Outil de matrice d'interopérabilité"] pour les configurations prises en charge.



== Fonctionnalités ONTAP de haut niveau

*Caractéristiques communes*

* Mise à l'échelle du cluster
* Authentification sécurisée et prise en charge RBAC
* Prise en charge multi-administrateur Zero Trust
* Multilocation sécurisée
* Répliquer des données avec SnapMirror.
* Copies ponctuelles avec instantanés.
* Clones peu encombrants.
* Fonctionnalités d'efficacité du stockage telles que la déduplication, la compression, etc.
* Prise en charge de Trident CSI pour Kubernetes
* Snaplock
* Verrouillage de copie d'instantané inviolable
* Prise en charge du cryptage
* FabricPool pour hiérarchiser les données froides vers le magasin d'objets.
* Intégration BlueXP et CloudInsights.
* Transfert de données déchargé Microsoft (ODX)


*NAS*

* Les volumes FlexGroup sont un conteneur NAS évolutif, offrant des performances élevées ainsi qu'une répartition de la charge et une évolutivité.
* FlexCache permet de distribuer les données à l'échelle mondiale tout en fournissant un accès local en lecture et en écriture aux données.
* La prise en charge multiprotocole permet aux mêmes données d'être accessibles via SMB, ainsi que via NFS.
* NFS nConnect autorise plusieurs sessions TCP par connexion TCP, augmentant ainsi le débit du réseau.  Cela augmente l’utilisation des cartes réseau à haut débit disponibles sur les serveurs modernes.
* La jonction de session NFS offre des vitesses de transfert de données accrues, une haute disponibilité et une tolérance aux pannes.
* Le multicanal SMB offre une vitesse de transfert de données accrue, une haute disponibilité et une tolérance aux pannes.
* Intégration avec Active Directory/LDAP pour les autorisations de fichiers.
* Connexion sécurisée avec NFS sur TLS.
* Prise en charge de NFS Kerberos.
* NFS sur RDMA.
* Mappage de noms entre les identités Windows et Unix.
* Protection autonome contre les ransomwares.
* Analyse du système de fichiers.


*SAN*

* Étirez le cluster sur les domaines de pannes avec la synchronisation active SnapMirror .
* Les modèles ASA offrent un multi-accès actif/actif et un basculement de chemin rapide.
* Prise en charge des protocoles FC, iSCSI, NVMe-oF.
* Prise en charge de l'authentification mutuelle iSCSI CHAP.
* Carte LUN sélective et ensemble de ports.




== Types de stockage Proxmox VE pris en charge avec ONTAP

Les protocoles NAS (NFS/SMB) prennent en charge tous les types de contenu de Proxmox VE et sont généralement configurés une fois au niveau du centre de données.  Les machines virtuelles invitées peuvent utiliser des disques de type raw, qcow2 ou VMDK sur le stockage NAS.  Les instantanés ONTAP peuvent être rendus visibles pour accéder à des copies ponctuelles des données du client.  Le stockage en bloc avec les protocoles SAN (FC/iSCSI/NVMe-oF) est généralement configuré par hôte et est limité aux types de contenu VM Disk et Container Image pris en charge par Proxmox VE.  Les machines virtuelles invitées et les conteneurs consomment du stockage en blocs sous forme de périphériques bruts.

[cols="25% 15% 15% 15% 15% 15%"]
|===
| Type de contenu | NFS | PME/CIFS | FC | iSCSI | NVMe-oF 


| Sauvegardes | Oui | Oui  a| 
Non^1^
 a| 
Non^1^
 a| 
Non^1^



| Disques VM | Oui | Oui  a| 
Oui^2^
 a| 
Oui^2^
 a| 
Oui^2^



| Volumes CT | Oui | Oui  a| 
Oui^2^
 a| 
Oui^2^
 a| 
Oui^2^



| Images ISO | Oui | Oui  a| 
Non^1^
 a| 
Non^1^
 a| 
Non^1^



| Modèles CT | Oui | Oui  a| 
Non^1^
 a| 
Non^1^
 a| 
Non^1^



| Extraits | Oui | Oui  a| 
Non^1^
 a| 
Non^1^
 a| 
Non^1^

|===
*Remarques :* 1 - Nécessite un système de fichiers en cluster pour créer le dossier partagé et utiliser le type de stockage Répertoire.  2 - utiliser le type de stockage LVM.



== Stockage SMB/CIFS

Pour utiliser les partages de fichiers SMB/CIFS, certaines tâches doivent être effectuées par l'administrateur de stockage et l'administrateur de virtualisation peut monter le partage à l'aide de l'interface utilisateur Proxmox VE ou à partir du shell.  Le multicanal SMB offre une tolérance aux pannes et améliore les performances.  Pour plus de détails, reportez-vous àlink:https://www.netapp.com/pdf.html?item=/media/17136-tr4740.pdf["TR4740 - SMB 3.0 multicanal"]


NOTE: Le mot de passe sera enregistré dans un fichier texte clair et accessible uniquement à l'utilisateur root. link:https://pve.proxmox.com/pve-docs/chapter-pvesm.html#storage_cifs["Documentation de Proxmox VE"] .

.Pool de stockage partagé SMB avec ONTAP
video::5b4ae54a-08d2-4f7d-95ec-b22d015f6035[panopto,width=360]
.<strong>Tâches d'administration du stockage</strong>
[%collapsible%open]
====
Si vous êtes nouveau sur ONTAP, utilisez l'interface du gestionnaire système pour effectuer ces tâches afin d'obtenir une meilleure expérience.

. Assurez-vous que SVM est activé pour SMB.  Suivrelink:https://docs.netapp.com/us-en/ontap/smb-config/configure-access-svm-task.html["Documentation ONTAP 9"] pour plus d'informations.
. Avoir au moins deux vies par contrôleur.  Suivez les étapes du lien ci-dessus.  Pour référence, voici une capture d'écran des lifs utilisés dans cette solution.
+
image:proxmox-ontap-001.png["détails de l'interface NAS"]

. Utilisez l’authentification basée sur Active Directory ou sur un groupe de travail.  Suivez les étapes du lien ci-dessus.
+
image:proxmox-ontap-002.png["Rejoindre les informations du domaine"]

. Créer un volume.  N'oubliez pas de cocher l'option permettant de distribuer les données sur le cluster pour utiliser FlexGroup.
+
image:proxmox-ontap-023.png["Option FlexGroup"]

. Créez un partage SMB et ajustez les autorisations.  Suivrelink:https://docs.netapp.com/us-en/ontap/smb-config/configure-client-access-shared-storage-concept.html["Documentation ONTAP 9"] pour plus d'informations.
+
image:proxmox-ontap-003.png["Informations sur les partages de PME"]

. Fournissez le serveur SMB, le nom de partage et les informations d’identification à l’administrateur de virtualisation pour qu’il puisse terminer la tâche.


====
.<strong>Tâches d'administration de la virtualisation</strong>
[%collapsible%open]
====
. Collectez le serveur SMB, le nom de partage et les informations d’identification à utiliser pour l’authentification du partage.
. Assurez-vous qu'au moins deux interfaces sont configurées dans des VLAN différents (pour la tolérance aux pannes) et que la carte réseau prend en charge RSS.
. Si vous utilisez l'interface utilisateur de gestion `https:<proxmox-node>:8006` , cliquez sur le centre de données, sélectionnez le stockage, cliquez sur Ajouter et sélectionnez SMB/CIFS.
+
image:proxmox-ontap-004.png["Navigation dans le stockage SMB"]

. Remplissez les détails et le nom du partage devrait être renseigné automatiquement.  Assurez-vous que tout le contenu est sélectionné.  Cliquez sur Ajouter.
+
image:proxmox-ontap-005.png["Ajout de stockage SMB"]

. Pour activer l'option multicanal, accédez au shell sur l'un des nœuds du cluster et tapez pvesm set pvesmb01 --options multichannel,max_channels=4
+
image:proxmox-ontap-006.png["configuration multicanal"]

. Voici le contenu de /etc/pve/storage.cfg pour les tâches ci-dessus.
+
image:proxmox-ontap-007.png["fichier de configuration de stockage pour SMB"]



====


== Stockage NFS

ONTAP prend en charge toutes les versions NFS prises en charge par Proxmox VE.  Pour assurer la tolérance aux pannes et améliorer les performances, assurez-vouslink:https://docs.netapp.com/us-en/ontap/nfs-trunking/index.html["jonction de session"] est utilisé.  Pour utiliser la jonction de session, NFS v4.1 minimum est requis.

Si vous êtes nouveau sur ONTAP, utilisez l'interface du gestionnaire système pour effectuer ces tâches afin d'obtenir une meilleure expérience.

.Option NFS nconnect avec ONTAP
video::f6c9aba3-b070-45d6-8048-b22e001acfd4[panopto,width=360]
.<strong>Tâches d'administration du stockage</strong>
[%collapsible%open]
====
. Assurez-vous que SVM est activé pour NFS. Consultez link:https://docs.netapp.com/us-en/ontap/nfs-config/verify-protocol-enabled-svm-task.html["Documentation ONTAP 9"]
. Avoir au moins deux vies par contrôleur.  Suivez les étapes du lien ci-dessus.  Pour référence, voici la capture d'écran des lifs que nous utilisons dans notre laboratoire.
+
image:proxmox-ontap-001.png["détails de l'interface NAS"]

. Créez ou mettez à jour la politique d'exportation NFS fournissant l'accès aux adresses IP ou au sous-réseau de l'hôte Proxmox VE. Se référer àlink:https://docs.netapp.com/us-en/ontap/nfs-config/create-export-policy-task.html["Création d'une politique d'exportation"] etlink:https://docs.netapp.com/us-en/ontap/nfs-config/add-rule-export-policy-task.html["Ajouter une règle à une politique d'exportation"] .
. link:https://docs.netapp.com/us-en/ontap/nfs-config/create-volume-task.html["Créer un volume"] . N'oubliez pas de cocher l'option permettant de distribuer les données sur le cluster pour utiliser FlexGroup.
+
image:proxmox-ontap-023.png["Option FlexGroup"]

. link:https://docs.netapp.com/us-en/ontap/nfs-config/associate-export-policy-flexvol-task.html["Affecter une politique d'exportation au volume"]
+
image:proxmox-ontap-008.png["Informations sur le volume NFS"]

. Informez l’administrateur de virtualisation que le volume NFS est prêt.


====
.<strong>Tâches d'administration de la virtualisation</strong>
[%collapsible%open]
====
. Assurez-vous qu'au moins deux interfaces sont configurées dans des VLAN différents (pour la tolérance aux pannes).  Utiliser la liaison NIC.
. Si vous utilisez l'interface utilisateur de gestion `https:<proxmox-node>:8006` , cliquez sur le centre de données, sélectionnez le stockage, cliquez sur Ajouter et sélectionnez NFS.
+
image:proxmox-ontap-009.png["Navigation dans le stockage NFS"]

. Remplissez les détails. Après avoir fourni les informations du serveur, les exportations NFS doivent être renseignées et sélectionnées dans la liste.  N'oubliez pas de sélectionner les options de contenu.
+
image:proxmox-ontap-010.png["Ajout de stockage NFS"]

. Pour la jonction de session, sur chaque hôte Proxmox VE, mettez à jour le fichier /etc/fstab pour monter la même exportation NFS en utilisant une adresse lif différente avec max_connect et l'option de version NFS.
+
image:proxmox-ontap-011.png["entrées fstab pour le tronc de session"]

. Voici le contenu de /etc/pve/storage.cfg pour NFS.
+
image:proxmox-ontap-012.png["fichier de configuration de stockage pour NFS"]



====


== LVM avec iSCSI

.Pool partagé LVM avec iSCSI utilisant ONTAP
video::d66ef67f-bcc2-4ced-848e-b22e01588e8c[panopto,width=360]
Pour configurer Logical Volume Manager pour le stockage partagé entre les hôtes Proxmox, effectuez les tâches suivantes :

.<strong>Tâches d'administration de la virtualisation</strong>
[%collapsible%open]
====
. Assurez-vous que deux interfaces VLAN Linux sont disponibles.
. Assurez-vous que multipath-tools est installé sur tous les hôtes Proxmox VE.  Assurez-vous qu'il démarre au démarrage.
+
[source, shell]
----
apt list | grep multipath-tools
# If need to install, execute the following line.
apt-get install multipath-tools
systemctl enable multipathd
----
. Collectez l'iqn de l'hôte iscsi pour tous les hôtes Proxmox VE et fournissez-le à l'administrateur du stockage.
+
[source, shell]
----
cat /etc/iscsi/initiator.name
----


====
.<strong>Tâches d'administration du stockage</strong>
[%collapsible%open]
====
Si vous êtes nouveau sur ONTAP, utilisez System Manager pour une meilleure expérience.

. Assurez-vous que SVM est disponible avec le protocole iSCSI activé.  Suivrelink:https://docs.netapp.com/us-en/ontap/san-admin/provision-storage.html["Documentation ONTAP 9"]
. Avoir deux LIF par contrôleur dédiés à iSCSI.
+
image:proxmox-ontap-013.png["détails de l'interface iscsi"]

. Créez un igroup et renseignez les initiateurs iscsi de l'hôte.
. Créez le LUN avec la taille souhaitée sur le SVM et présentez-le au groupe igroup créé à l'étape ci-dessus.
+
image:proxmox-ontap-014.png["détails de l'ISCSI LUN"]

. Avertissez l'administrateur de virtualisation que le LUN est créé.


====
.<strong>Tâches d'administration de la virtualisation</strong>
[%collapsible%open]
====
. Accéder à l'interface de gestion `https:<proxmox node>:8006` , cliquez sur le centre de données, sélectionnez le stockage, cliquez sur Ajouter et sélectionnez iSCSI.
+
image:proxmox-ontap-015.png["navigation dans le stockage iscsi"]

. Fournir le nom de l'ID de stockage.  L'adresse lif iSCSI d' ONTAP devrait pouvoir choisir la cible lorsqu'il n'y a pas de problème de communication.  Comme notre intention n'est pas de fournir directement l'accès LUN à la machine virtuelle invitée, décochez cette case.
+
image:proxmox-ontap-016.png["création du type de stockage iscsi"]

. Maintenant, cliquez sur Ajouter et sélectionnez LVM.
+
image:proxmox-ontap-017.png["navigation dans le stockage LVM"]

. Fournissez le nom de l'ID de stockage, choisissez le stockage de base qui doit correspondre au stockage iSCSI que nous avons créé à l'étape ci-dessus.  Choisissez le LUN pour le volume de base.  Indiquez le nom du groupe de volumes.  Assurez-vous que l'option partagée est sélectionnée.
+
image:proxmox-ontap-018.png["création de stockage lvm"]

. Voici l'exemple de fichier de configuration de stockage pour LVM utilisant un volume iSCSI.
+
image:proxmox-ontap-019.png["configuration lvm iscsi"]



====


== LVM avec NVMe/TCP

.Pool partagé LVM avec NVMe/TCP utilisant ONTAP
video::80164fe4-06db-4c21-a25d-b22e0179c3d2[panopto,width=360]
Pour configurer Logical Volume Manager pour le stockage partagé entre les hôtes Proxmox, effectuez les tâches suivantes :

.<strong>Tâches d'administration de la virtualisation</strong>
[%collapsible%open]
====
. Assurez-vous que deux interfaces VLAN Linux sont disponibles.
. Sur chaque hôte Proxmox du cluster, exécutez la commande suivante pour collecter les informations de l’initiateur de l’hôte.
+
[source, shell]
----
nvme show-hostnqn
----
. Fournissez les informations d'hôte nqn collectées à l'administrateur de stockage et demandez un espace de noms NVME de la taille requise.


====
.<strong>Tâches d'administration du stockage</strong>
[%collapsible%open]
====
Si vous êtes nouveau sur ONTAP, utilisez System Manager pour une meilleure expérience.

. Assurez-vous que SVM est disponible avec le protocole NVMe activé.  Référerlink:https://docs.netapp.com/us-en/ontap/san-admin/create-nvme-namespace-subsystem-task.html["Documentation des tâches NVMe sur ONTAP 9"] .
. Créez l’espace de noms NVMe.
+
image:proxmox-ontap-020.png["création d'espace de noms NVME"]

. Créez un sous-système et attribuez des nqns d'hôte (si vous utilisez CLI).  Suivez le lien de référence ci-dessus.
. Informez l’administrateur de virtualisation que l’espace de noms NVME est créé.


====
.<strong>Tâches d'administration de la virtualisation</strong>
[%collapsible%open]
====
. Accédez au shell sur chaque hôte Proxmox VE du cluster et créez le fichier /etc/nvme/discovery.conf et mettez à jour le contenu spécifique à votre environnement.
+
[source, shell]
----
root@pxmox01:~# cat /etc/nvme/discovery.conf
# Used for extracting default parameters for discovery
#
# Example:
# --transport=<trtype> --traddr=<traddr> --trsvcid=<trsvcid> --host-traddr=<host-traddr> --host-iface=<host-iface>

-t tcp -l 1800 -a 172.21.118.153
-t tcp -l 1800 -a 172.21.118.154
-t tcp -l 1800 -a 172.21.119.153
-t tcp -l 1800 -a 172.21.119.154
----
. Connectez-vous au sous-système NVME
+
[source, shell]
----
nvme connect-all
----
. Inspectez et collectez les détails de l'appareil.
+
[source, shell]
----
nvme list
nvme netapp ontapdevices
nvme list-subsys
lsblk -l
----
. Créer un groupe de volumes
+
[source, shell]
----
vgcreate pvens02 /dev/mapper/<device id>
----
. Accéder à l'interface de gestion `https:<proxmox node>:8006` , cliquez sur le centre de données, sélectionnez le stockage, cliquez sur Ajouter et sélectionnez LVM.
+
image:proxmox-ontap-017.png["navigation dans le stockage LVM"]

. Fournissez le nom de l'ID de stockage, choisissez le groupe de volumes existant et sélectionnez le groupe de volumes qui vient d'être créé avec la CLI.  N'oubliez pas de cocher l'option partagée.
+
image:proxmox-ontap-021.png["lvm sur vg existant"]

. Voici un exemple de fichier de configuration de stockage pour LVM utilisant NVMe/TCP
+
image:proxmox-ontap-022.png["configuration TCP de LVM sur NVME"]



====