---
sidebar: sidebar 
permalink: vmware/vmw-vcf-disaster-recovery-nfs.html 
keywords: netapp, vmware, cloud, foundation, vcf, nfs 
summary: Solution de reprise après sinistre pour VCF avec NetApp Disaster Recovery. 
---
= Mise en œuvre d'une solution de reprise après sinistre avec NetApp Disaster Recovery
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Solution de reprise après sinistre VCF pour les datastores NFS avec NetApp SnapMirror et NetApp Disaster Recovery

La réplication au niveau des blocs d'un site de production vers un site de reprise après sinistre (DR) offre une stratégie résiliente et rentable pour protéger les charges de travail contre les pannes de site et les événements de corruption de données, y compris les attaques de ransomware.  La réplication NetApp SnapMirror permet aux domaines de charge de travail VMware VCF 9 exécutés sur des systèmes ONTAP sur site (à l'aide de banques de données NFS ou VMFS) d'être répliqués vers un système ONTAP secondaire situé dans un centre de données de récupération désigné où VMware est également déployé.

Pour plus d'informations, consultez la section suivante.link:https://docs.netapp.com/us-en/data-services-disaster-recovery/["Documentation sur la NetApp Disaster Recovery"] .

Cette section décrit la configuration de NetApp Disaster Recovery pour établir une reprise après sinistre pour les machines virtuelles VMware sur site.

L'installation comprend :

* Création d'un compte NetApp Console et déploiement d'un agent.
* Ajout de baies ONTAP à la NetApp Console pour les systèmes gérés afin de faciliter la communication entre VMware vCenter et le stockage ONTAP .
* Configuration de la réplication entre les sites à l’aide de SnapMirror.
* Mise en place et test d’un plan de récupération pour valider la préparation au basculement.


NetApp Disaster Recovery, intégré à la NetApp Console, permet aux entreprises de découvrir facilement leurs systèmes de stockage VMware vCenter et ONTAP sur site. Une fois découverts, les administrateurs peuvent définir des regroupements de ressources, créer des plans de reprise après sinistre, les associer aux ressources appropriées et lancer ou tester des opérations de basculement et de restauration. NetApp SnapMirror fournit une réplication efficace au niveau des blocs, garantissant que le site DR reste synchronisé avec l'environnement de production via des mises à jour incrémentielles. Cela permet un objectif de point de récupération (RPO) aussi court que cinq minutes.

NetApp Disaster Recovery prend également en charge les tests de reprise après sinistre sans interruption. En exploitant la technologie FlexClone d'ONTAP, il crée des copies temporaires et peu encombrantes du magasin de données NFS à partir du snapshot répliqué le plus récent, sans impacter les charges de travail de production ni entraîner de coûts de stockage supplémentaires. Après les tests, l’environnement peut être facilement supprimé, préservant ainsi l’intégrité des données répliquées.

En cas de basculement réel, NetApp Console orchestre le processus de récupération, en redémarrant automatiquement les machines virtuelles protégées sur le site de reprise d'activité désigné avec une intervention minimale de l'utilisateur. Lorsque le site principal est restauré, le service inverse la relation SnapMirror et réplique toutes les modifications sur le site d'origine, permettant une restauration fluide et contrôlée.

Toutes ces fonctionnalités sont fournies à un coût nettement inférieur à celui des solutions de reprise après sinistre traditionnelles.

image::vmw-vcf-dr-nfs-001.png[Diagramme d'architecture de NetApp Disaster Recovery]



== Commencer

Pour commencer à utiliser NetApp Disaster Recovery, utilisez la NetApp Console puis accédez au service.

. Connectez-vous à la NetApp Console.
. Dans le menu de navigation de gauche de la NetApp Console , sélectionnez Protection > Reprise après sinistre.
. Le tableau de bord de NetApp Disaster Recovery s'affiche.
+
image::vmw-vcf-dr-nfs-002.png[Tableau de bord de NetApp Disaster Recovery]



Avant de configurer le plan de reprise après sinistre, assurez-vous des points suivants :link:https://docs.netapp.com/us-en/data-services-disaster-recovery/get-started/dr-prerequisites.html["prérequis"] sont rencontrés :

* L'agent Console est configuré dans la NetApp Console.
* L'instance de l'agent dispose d'une connectivité au domaine de charge de travail source et de destination vCenter et aux systèmes de stockage.
* Cluster NetApp Data ONTAP pour fournir des magasins de données NFS ou VMFS de stockage.
* Les systèmes de stockage NetApp sur site hébergeant des datastores NFS ou VMFS pour VMware sont ajoutés dans la NetApp Console.
* La résolution DNS doit être en place lors de l'utilisation de noms DNS. Sinon, utilisez les adresses IP pour le vCenter.
* La réplication SnapMirror est configurée pour les volumes de banque de données désignés basés sur NFS ou VMFS.
* Assurez-vous que l’environnement dispose de versions prises en charge des serveurs vCenter Server et ESXi.


Une fois la connectivité établie entre les sites source et de destination, procédez aux étapes de configuration, qui devraient prendre quelques clics et environ 3 à 5 minutes.

Remarque : NetApp recommande de déployer l’agent Console sur le site de destination ou sur un site tiers, afin que l’agent puisse communiquer via le réseau avec les ressources source et de destination.

Dans cette démonstration, les domaines de charge de travail sont configurés avec le stockage ONTAP NFS.  Les étapes en termes de flux de travail restent les mêmes pour les magasins de données basés sur VMFS.

image::vmw-vcf-dr-nfs-003.png[Tableau de bord détaillé de NetApp Disaster Recovery]



== Configuration de NetApp Disaster Recovery

La première étape de la préparation à la reprise après sinistre consiste à découvrir et à ajouter le vCenter source et les ressources de stockage à NetApp Disaster Recovery.

Ouvrez la NetApp Console et sélectionnez Protection > Reprise après sinistre dans le menu de navigation de gauche. Sélectionnez Sites, puis choisissez Ajouter. Saisissez un nom pour le nouveau site source et ses emplacements. Répétez cette étape pour ajouter le site et l'emplacement de destination.

image::vmw-vcf-dr-nfs-004.png[Tableau de bord détaillé de NetApp Disaster Recovery]

Ajoutez les plateformes suivantes :

* Domaine de charge de travail source vCenter
* Domaine de charge de travail de destination vCenter.


Une fois les vCenters ajoutés, la découverte automatisée est déclenchée.



== Configuration de la réplication du stockage entre la baie du site source et la baie du site de destination

SnapMirror assure la réplication des données dans un environnement NetApp . Construite sur la technologie NetApp Snapshot®, la réplication SnapMirror est extrêmement efficace car elle réplique uniquement les blocs qui ont été modifiés ou ajoutés depuis la mise à jour précédente. SnapMirror est facilement configuré à l'aide de NetApp OnCommand® System Manager ou de l'interface de ligne de commande ONTAP . NetApp Disaster Recovery crée également la relation SnapMirror à condition que le peering de clusters et de SVM soit configuré au préalable.

Dans les cas où le stockage principal n'est pas totalement perdu, SnapMirror offre un moyen efficace de resynchroniser les sites principal et de reprise après sinistre. SnapMirror peut resynchroniser les deux sites, en transférant uniquement les données modifiées ou nouvelles du site de secours vers le site principal, simplement en inversant les relations SnapMirror . Cela signifie que les plans de réplication dans NetApp Disaster Recovery peuvent être resynchronisés dans les deux sens après un basculement sans avoir à recopier l'intégralité du volume. Si une relation est resynchronisée dans le sens inverse, seules les nouvelles données écrites depuis la dernière synchronisation réussie de la copie Snapshot sont renvoyées à la destination.


NOTE: Si la relation SnapMirror est déjà configurée pour le volume via l'interface de ligne de commande (CLI) ou System Manager, NetApp Disaster Recovery reprend la relation et poursuit le reste des opérations du flux de travail.



== Comment configurer les relations de réplication pour NetApp Disaster Recovery ?

Le processus sous-jacent de création d'une réplication SnapMirror reste le même pour toute application donnée.  La solution la plus simple consiste à tirer parti de NetApp Disaster Recovery, qui automatisera le flux de travail de réplication à condition que les deux critères suivants soient remplis : Le processus peut être manuel ou automatisé. Le plus simple est d’utiliser NetApp Disaster Recovery, qui automatise le workflow de réplication, à condition que les deux critères suivants soient remplis :

* Les clusters source et de destination ont une relation d’homologue.
* La SVM source et la SVM de destination ont une relation homologue.


La NetApp Console offre également une autre option pour configurer la réplication SnapMirror en utilisant un simple glisser-déposer du système ONTAP source de l'environnement vers la destination pour déclencher l'assistant qui vous guidera tout au long du reste du processus.



== Que peut faire NetApp Disaster Recovery pour vous ?

Une fois les sites source et de destination ajoutés, NetApp Disaster Recovery effectue une analyse approfondie automatique et affiche les machines virtuelles ainsi que les métadonnées associées. NetApp Disaster Recovery détecte et configure automatiquement les réseaux et les groupes de ports utilisés par les machines virtuelles.

image::vmw-vcf-dr-nfs-005.png[Sites de NetApp Console]

Une fois les sites ajoutés, configurez le plan de réplication en sélectionnant les plateformes vCenter source et de destination, puis choisissez les groupes de ressources à inclure dans le plan, ainsi que le regroupement des applications à restaurer et à mettre sous tension, et le mappage des clusters et des réseaux. Pour définir le plan de récupération, accédez à l'onglet *Plans de réplication* et cliquez sur *Ajouter*.

Dans cette étape, les machines virtuelles peuvent être regroupées en groupes de ressources. Les groupes de ressources de NetApp Disaster Recovery vous permettent de regrouper un ensemble de machines virtuelles dépendantes en groupes logiques qui contiennent leurs ordres de démarrage et leurs délais de démarrage pouvant être exécutés lors de la récupération. Les groupes de ressources peuvent être définis lors de la création du plan de réplication ou en utilisant l'onglet Groupe de ressources dans le menu de navigation de gauche.

Commencez par nommer le plan de réplication et sélectionnez le vCenter source et le vCenter de destination.

image::vmw-vcf-dr-nfs-006.png[NetApp Disaster Recovery cible vCenter]

L'étape suivante consiste à choisir si vous allez créer un plan de réplication avec des groupes de ressources, des machines virtuelles ou des banques de données. Sélectionnez un groupe de ressources existant et, si aucun groupe de ressources n'est créé, l'assistant vous aidera à regrouper les machines virtuelles requises (en créant essentiellement des groupes de ressources fonctionnels) en fonction des objectifs de récupération. Cela permet également de définir la séquence d'opérations de restauration des machines virtuelles d'application.

image::vmw-vcf-dr-nfs-007.png[NetApp Disaster Recovery sélectionne les machines virtuelles à protéger]


NOTE: Le groupe de ressources permet de définir l'ordre de démarrage à l'aide de la fonctionnalité glisser-déposer. Il peut être utilisé pour modifier facilement l’ordre dans lequel les machines virtuelles seront mises sous tension pendant le processus de récupération.

Une fois les groupes de ressources créés via le plan de réplication, l'étape suivante consiste à créer le mappage pour récupérer les machines virtuelles et les applications en cas de sinistre. Dans cette étape, spécifiez comment les ressources de l'environnement source sont mappées vers la destination. Cela inclut les ressources de calcul, les réseaux virtuels, la personnalisation IP, les pré- et post-scripts, les délais de démarrage, la cohérence des applications, etc. Pour plus d'informations, veuillez consulterlink:https://docs.netapp.com/us-en/data-services-disaster-recovery/use/drplan-create.html#map-source-resources-to-the-target["Créer un plan de réplication"] . Comme indiqué dans les prérequis, la réplication SnapMirror peut être configurée au préalable ou DRaaS peut la configurer en utilisant le RPO et le nombre de rétentions spécifiés lors de la création du plan de réplication.

Remarque : par défaut, les mêmes paramètres de mappage sont utilisés pour les opérations de test et de basculement. Pour définir des mappages différents pour l'environnement de test, sélectionnez l'option Mappage de test après avoir décoché la case « Utiliser les mêmes mappages pour le basculement et les mappages de test ». Une fois la cartographie des ressources terminée, cliquez sur Suivant.

image::vmw-vcf-dr-nfs-008.png[Cartographie des ressources de secours NetApp]

Une fois terminé, vérifiez les mappages créés, puis cliquez sur Ajouter un plan.

image::vmw-vcf-dr-nfs-009.png[Examen de la cartographie des ressources de NetApp Disaster Recovery]


NOTE: Les machines virtuelles provenant de différents volumes et les SVM peuvent être incluses dans un plan de réplication. En fonction de l'emplacement de la machine virtuelle (sur le même volume ou sur un volume séparé au sein du même SVM, ou sur des volumes séparés sur des SVM différents), NetApp Disaster Recovery crée un instantané de groupe de cohérence.

image::vmw-vcf-dr-nfs-010.png[Plans de réplication de NetApp Disaster Recovery]

Dès que le plan est créé, une série de validations est déclenchée et la réplication et les planifications SnapMirror sont configurées selon la sélection.

image::vmw-vcf-dr-nfs-011.png[Surveillance des tâches de NetApp Disaster Recovery]

La NetApp Disaster Recovery comprend les flux de travail suivants :

* Test de basculement (y compris les simulations automatisées périodiques)
* Test de basculement de nettoyage
* Basculement :
+
** Migration planifiée (étendre le cas d'utilisation pour un basculement unique)
** Reprise après sinistre


* Retour arrière


image::vmw-vcf-dr-nfs-012.png[actions du plan de réplication de NetApp Disaster Recovery]



== Test de basculement

Le test de basculement dans NetApp Disaster Recovery est une procédure opérationnelle qui permet aux administrateurs VMware de valider intégralement leurs plans de reprise sans perturber leurs environnements de production.

image::vmw-vcf-dr-nfs-013.png[Basculement du test de réplication du plan de NetApp Disaster Recovery]

NetApp Disaster Recovery intègre la possibilité de sélectionner l'instantané comme fonctionnalité optionnelle lors de l'opération de basculement de test. Cette fonctionnalité permet à l'administrateur VMware de vérifier que toutes les modifications récemment apportées à l'environnement sont répliquées sur le site de destination et sont donc présentes lors du test. Ces modifications incluent des correctifs pour le système d’exploitation invité de la machine virtuelle.

image::vmw-vcf-dr-nfs-014.png[Confirmation de basculement du test du plan de réplication de NetApp Disaster Recovery]

Lorsqu'un administrateur VMware exécute une opération de basculement de test, NetApp Disaster Recovery automatise les tâches suivantes :

* Déclenchement des relations SnapMirror pour mettre à jour le stockage sur le site de destination avec toutes les modifications récentes apportées sur le site de production.
* Création de volumes NetApp FlexClone des volumes FlexVol sur la baie de stockage DR.
* Connexion des banques de données dans les volumes FlexClone aux hôtes ESXi sur le site DR.
* Connexion des adaptateurs réseau VM au réseau de test spécifié lors du mappage.
* Reconfiguration des paramètres réseau du système d’exploitation invité de la machine virtuelle tels que définis pour le réseau sur le site DR.
* Exécution de toutes les commandes personnalisées qui ont été stockées dans le plan de réplication.
* Mise sous tension des machines virtuelles dans l’ordre défini dans le plan de réplication.


image::vmw-vcf-dr-nfs-015.png[Résultat du test de basculement du plan de réplication de NetApp Disaster Recovery]



== Opération de test de basculement de nettoyage

L'opération de test de basculement de nettoyage se produit une fois le test du plan de réplication terminé et l'administrateur VMware répond à l'invite de nettoyage.

image::vmw-vcf-dr-nfs-016.png[Nettoyage du plan de réplication de reprise NetApp Disaster Recovery]

Cette action réinitialisera les machines virtuelles (VM) et l'état du plan de réplication à l'état prêt. Lorsqu'un administrateur VMware effectue une opération de récupération, NetApp Disaster Recovery effectue le processus suivant :

. Il met hors tension chaque machine virtuelle récupérée dans la copie FlexClone qui a été utilisée pour les tests.
. Il supprime le volume FlexClone qui a été utilisé pour présenter les machines virtuelles récupérées pendant le test.




== Migration planifiée et basculement

NetApp Disaster Recovery propose deux méthodes pour effectuer un véritable basculement : la migration planifiée et le basculement. La première méthode, la migration planifiée, intègre l'arrêt des machines virtuelles et la synchronisation de la réplication du stockage dans le processus afin de récupérer ou de déplacer efficacement les machines virtuelles vers le site de destination. La migration prévue nécessite un accès au site source. La deuxième méthode, le basculement, est un basculement planifié/non planifié dans lequel les machines virtuelles sont récupérées sur le site de destination à partir du dernier intervalle de réplication de stockage qui a pu se terminer. En fonction du RPO intégré à la solution, une certaine perte de données est à prévoir dans le scénario de reprise après sinistre.

image::vmw-vcf-dr-nfs-017.png[Action de basculement du plan de réplication de NetApp Disaster Recovery]

image::vmw-vcf-dr-nfs-018.png[Confirmation de l'action de basculement du plan de réplication de NetApp Disaster Recovery]

Lorsqu'un administrateur VMware effectue une opération de basculement, NetApp Disaster Recovery automatise les tâches suivantes :

* Interrompez et basculez les relations NetApp SnapMirror .
* Connectez les banques de données répliquées aux hôtes ESXi sur le site DR.
* Connectez les adaptateurs réseau VM au réseau du site de destination approprié.
* Reconfigurez les paramètres réseau du système d’exploitation invité de la machine virtuelle tels que définis pour le réseau sur le site de destination.
* Exécutez toutes les commandes personnalisées (le cas échéant) qui ont été stockées dans le plan de réplication.
* Mettez sous tension les machines virtuelles dans l’ordre défini dans le plan de réplication.


image::vmw-vcf-dr-nfs-019.png[Client vSphere - Machines virtuelles sous tension]



== Retour arrière

Une restauration est une procédure facultative qui restaure la configuration d’origine des sites source et de destination après une récupération.

image::vmw-vcf-dr-nfs-020.png[Action de restauration du plan de réplication de reprise NetApp Disaster Recovery]

Les administrateurs VMware peuvent configurer et exécuter une procédure de restauration automatique lorsqu’ils sont prêts à restaurer les services sur le site source d’origine.


NOTE: NetApp Disaster Recovery réplique (resynchronise) toutes les modifications vers la machine virtuelle source d'origine avant d'inverser le sens de la réplication.

Ce processus part d’une relation qui a terminé son basculement vers une cible et implique les étapes suivantes :

* Mettez hors tension et désenregistrez les machines virtuelles et les volumes sur le site de destination sont démontés.
+
image::vmw-vcf-dr-nfs-021.png[Client vSphere - tâches récentes]

* Rompre la relation SnapMirror sur la source d'origine est rompue pour la rendre en lecture/écriture.
* Resynchronisez la relation SnapMirror pour inverser la réplication.
* Montez le volume sur la source, mettez sous tension et enregistrez les machines virtuelles sources.
+
image::vmw-vcf-dr-nfs-022.png[Client vSphere - Machines virtuelles sous tension]



Pour plus de détails sur l'accès et la configuration de NetApp Disaster Recovery, consultez la documentation.link:https://docs.netapp.com/us-en/data-services-disaster-recovery/get-started/dr-intro.html["En savoir plus sur NetApp Disaster Recovery pour VMware"] .



== Surveillance et tableau de bord

Depuis NetApp Disaster Recovery ou l'interface de ligne de commande ONTAP , vous pouvez surveiller l'état de santé de la réplication pour les volumes de banque de données appropriés, et l'état d'un basculement ou d'un test de basculement peut être suivi via la surveillance des tâches.

image::vmw-vcf-dr-nfs-023.png[Surveillance des tâches de NetApp Disaster Recovery]


NOTE: Si un travail est actuellement en cours ou en file d'attente et que vous souhaitez l'arrêter, il existe une option pour l'annuler.

Grâce au tableau de bord de NetApp Disaster Recovery , évaluez en toute confiance l'état des sites de reprise après sinistre et des plans de réplication. Cela permet aux administrateurs d'identifier rapidement les sites et les forfaits sains, déconnectés ou dégradés.

image::vmw-vcf-dr-nfs-024.png[Tableau de bord mis à jour de la NetApp Disaster Recovery]

Cela fournit une solution puissante pour gérer un plan de reprise après sinistre personnalisé et sur mesure. Le basculement peut être effectué sous forme de basculement planifié ou de basculement en un clic lorsqu'un sinistre survient et qu'une décision est prise d'activer le site DR.
