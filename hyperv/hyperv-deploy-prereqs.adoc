---
sidebar: sidebar 
permalink: hyperv/hyperv-deploy-prereqs.html 
keywords: hyperv, hyper-v, deploy, netapp, virtualization, prereqs, pre-requisites 
summary: 'La solution fournit les étapes nécessaires au déploiement d"Hyper-V sur le stockage NetApp' 
---
= Préparez-vous à déployer Microsoft Hyper-V en exploitant les systèmes de stockage ONTAP
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Préparez votre environnement pour déployer un cluster Microsoft Hyper-V avec des systèmes de stockage ONTAP .  Cette procédure comprend l’installation des fonctionnalités de Windows Server, la configuration des interfaces réseau pour le trafic Hyper-V, le choix de la conception de stockage appropriée, l’installation des utilitaires d’hôte iSCSI, la configuration de l’initiateur Windows iSCSI et la création d’un cluster de basculement.



== Prérequis pour la procédure de déploiement

* Tout le matériel doit être certifié pour la version de Windows Server que vous exécutez, et la solution de cluster de basculement complète doit réussir tous les tests de l'assistant de validation d'une configuration.
* Nœuds Hyper-V joints au contrôleur de domaine (recommandé) et connectivité appropriée entre eux.
* Chaque nœud Hyper-V doit être configuré de manière identique.
* Adaptateurs réseau et commutateurs virtuels désignés configurés sur chaque serveur Hyper-V pour le trafic séparé pour la gestion, iSCSI, SMB, migration en direct.
* La fonctionnalité de cluster de basculement est activée sur chaque serveur Hyper-V.
* Les partages SMB ou CSV sont utilisés comme stockage partagé pour stocker les machines virtuelles et leurs disques pour le clustering Hyper-V.
* Le stockage ne doit pas être partagé entre différents clusters.  Prévoyez un ou plusieurs partages CSV/CIFS par cluster.
* Si le partage SMB est utilisé comme stockage partagé, les autorisations sur le partage SMB doivent être configurées pour accorder l’accès aux comptes d’ordinateur de tous les nœuds Hyper-V du cluster.


Pour plus d'informations, voir :

* link:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/system-requirements-for-hyper-v-on-windows#how-to-check-for-hyper-v-requirements["Configuration requise pour Hyper-V sur Windows Server"]
* link:https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134244(v=ws.11)#step-1-prepare-to-validate-hardware-for-a-failover-cluster["Valider le matériel pour un cluster de basculement"]
* link:https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj863389(v=ws.11)["Déployer un cluster Hyper-V"]




=== Installation des fonctionnalités Windows

Les étapes suivantes décrivent comment installer les fonctionnalités Windows Server 2022 requises.

*Tous les hôtes*

. Préparez le système d'exploitation Windows 2022 avec les mises à jour et les pilotes de périphériques nécessaires sur tous les nœuds désignés.
. Connectez-vous à chaque nœud Hyper-V à l’aide du mot de passe administrateur saisi lors de l’installation.
. Lancez une invite PowerShell en cliquant avec le bouton droit sur l'icône PowerShell dans la barre des tâches et en sélectionnant `Run as Administrator` .
. Ajoutez les fonctionnalités Hyper-V, MPIO et de clustering.
+
[source, cli]
----
Add-WindowsFeature Hyper-V, Failover-Clustering, Multipath-IO `-IncludeManagementTools –Restart
----




=== Configuration des réseaux

Une planification réseau appropriée est essentielle pour parvenir à un déploiement tolérant aux pannes.  La configuration d’adaptateurs réseau physiques distincts pour chaque type de trafic était la suggestion standard pour un cluster de basculement.  Avec la possibilité d'ajouter des adaptateurs réseau virtuels, de combiner des commutateurs intégrés (SET) et des fonctionnalités telles que Hyper-V QoS, concentrez le trafic réseau sur moins d'adaptateurs physiques.  Concevez la configuration du réseau en tenant compte de la qualité de service, de la redondance et de l’isolation du trafic.  La configuration de techniques d'isolation réseau telles que les VLAN en conjonction avec des techniques d'isolation du trafic fournit une redondance pour le trafic et la qualité de service, ce qui améliorerait et ajouterait de la cohérence aux performances du trafic de stockage.

Il est conseillé de séparer et d’isoler des charges de travail spécifiques à l’aide de plusieurs réseaux logiques et/ou physiques.  Voici des exemples typiques de trafic réseau généralement divisés en segments :

* Réseau de stockage ISCSI.
* Réseau CSV (Cluster Shared Volume) ou Heartbeat.
* Migration en direct
* Réseau de machines virtuelles
* Réseau de gestion


*Remarque* : lorsque iSCSI est utilisé avec des cartes réseau dédiées, l’utilisation d’une solution de regroupement n’est pas recommandée et MPIO/DSM doit être utilisé.

*Remarque* : les meilleures pratiques de mise en réseau Hyper-V ne recommandent pas non plus d’utiliser l’association de cartes réseau pour les réseaux de stockage SMB 3.0 dans un environnement Hyper-V.

Pour plus d'informations, reportez-vous àlink:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/plan/plan-hyper-v-networking-in-windows-server["Planifier la mise en réseau Hyper-V dans Windows Server"]



=== Déterminer la conception du stockage pour Hyper-V

Hyper-V prend en charge le stockage NAS (SMB3.0) et le stockage en bloc (iSCSI/FC) comme stockage de sauvegarde pour les machines virtuelles.  NetApp prend en charge les protocoles SMB3.0, iSCSI et FC qui peuvent être utilisés comme stockage natif pour les machines virtuelles - volumes partagés en cluster (CSV) utilisant iSCSI/FC et SMB3.  Les clients peuvent également utiliser SMB3 et iSCSI comme options de stockage connectées aux invités pour les charges de travail qui nécessitent un accès direct au stockage.  ONTAP fournit des options flexibles avec un stockage unifié (All Flash Array) - pour les charges de travail nécessitant un accès à un protocole mixte et un stockage optimisé SAN (All SAN Array) pour les configurations SAN uniquement.

La décision d'utiliser SMB3 plutôt qu'iSCSI/FC est motivée par l'infrastructure existante en place aujourd'hui. SMB3/iSCSI permet aux clients d'utiliser l'infrastructure réseau existante.  Les clients disposant d'une infrastructure FC existante peuvent exploiter cette infrastructure et présenter le stockage sous forme de volumes partagés en cluster basés sur FC.

*Remarque :* un contrôleur de stockage NetApp exécutant le logiciel ONTAP peut prendre en charge les charges de travail suivantes dans un environnement Hyper-V :

* Machines virtuelles hébergées sur des partages SMB 3.0 disponibles en continu
* Machines virtuelles hébergées sur des LUN CSV (Cluster Shared Volume) exécutés sur iSCSI ou FC
* Stockage en invité et transfert de disques vers les machines virtuelles invitées


*Remarque* : les fonctionnalités principales ONTAP telles que le provisionnement dynamique, la déduplication, la compression, le compactage des données, les clones flexibles, les instantanés et la réplication fonctionnent de manière transparente en arrière-plan, quelle que soit la plate-forme ou le système d’exploitation, et offrent une valeur significative pour les charges de travail Hyper-V.  Les paramètres par défaut de ces fonctionnalités sont optimaux pour Windows Server et Hyper-V.

*Remarque* : MPIO est pris en charge sur la machine virtuelle invitée à l'aide d'initiateurs intégrés si plusieurs chemins sont disponibles pour la machine virtuelle et si la fonctionnalité d'E/S multichemin est installée et configurée.

*Remarque* : ONTAP prend en charge tous les principaux protocoles clients standard du secteur : NFS, SMB, FC, FCoE, iSCSI, NVMe/FC et S3.  Cependant, NVMe/FC et NVMe/TCP ne sont pas pris en charge par Microsoft.



=== Installation des utilitaires hôtes NetApp Windows iSCSI

La section suivante décrit comment effectuer une installation sans assistance des utilitaires hôtes iSCSI Windows NetApp .  Pour des informations détaillées concernant l'installation, consultez lelink:https://docs.netapp.com/us-en/ontap-sanhost/hu_wuhu_72.html["Installez Windows Unified Host Utilities 7.2 (ou la dernière version prise en charge)"]

*Tous les hôtes*

. Téléchargerlink:https://mysupport.netapp.com/site/products/all/details/hostutilities/downloads-tab/download/61343/7.2["Utilitaires de l'hôte Windows iSCSI"]
. Débloquer le fichier téléchargé.
+
[source, cli]
----
Unblock-file ~\Downloads\netapp_windows_host_utilities_7.2_x64.msi
----
. Installez les utilitaires hôtes.
+
[source, cli]
----
~\Downloads\netapp_windows_host_utilities_7.2_x64.msi /qn "MULTIPATHING=1"
----


*Remarque* : Le système redémarrera pendant ce processus.



=== Configuration de l'initiateur iSCSI de l'hôte Windows

Les étapes suivantes décrivent comment configurer l’initiateur Microsoft iSCSI intégré.

*Tous les hôtes*

. Lancez une invite PowerShell en cliquant avec le bouton droit sur l’icône PowerShell dans la barre des tâches et en sélectionnant Exécuter en tant qu’administrateur.
. Configurez le service iSCSI pour qu'il démarre automatiquement.
+
[source, cli]
----
Set-Service -Name MSiSCSI -StartupType Automatic
----
. Démarrez le service iSCSI.
+
[source, cli]
----
Start-Service -Name MSiSCSI
----
. Configurez MPIO pour revendiquer n’importe quel périphérique iSCSI.
+
[source, cli]
----
Enable-MSDSMAutomaticClaim -BusType iSCSI
----
. Définissez la politique d'équilibrage de charge par défaut de tous les nouveaux appareils réclamés sur Round Robin.
+
[source, cli]
----
Set-MSDSMGlobalDefaultLoadBalancePolicy -Policy RR 
----
. Configurez une cible iSCSI pour chaque contrôleur.
+
[source, cli]
----
New-IscsiTargetPortal -TargetPortalAddress <<iscsia_lif01_ip>> -InitiatorPortalAddress <iscsia_ipaddress>

New-IscsiTargetPortal -TargetPortalAddress <<iscsib_lif01_ip>> -InitiatorPortalAddress <iscsib_ipaddress

New-IscsiTargetPortal -TargetPortalAddress <<iscsia_lif02_ip>> -InitiatorPortalAddress <iscsia_ipaddress>

New-IscsiTargetPortal -TargetPortalAddress <<iscsib_lif02_ip>> -InitiatorPortalAddress <iscsib_ipaddress>
----
. Connectez une session pour chaque réseau iSCSI à chaque cible.
+
[source, cli]
----
Get-IscsiTarget | Connect-IscsiTarget -IsPersistent $true -IsMultipathEnabled $true -InitiatorPo rtalAddress <iscsia_ipaddress>

Get-IscsiTarget | Connect-IscsiTarget -IsPersistent $true -IsMultipathEnabled $true -InitiatorPo rtalAddress <iscsib_ipaddress>
----


*Remarque* : ajoutez plusieurs sessions (minimum 5 à 8) pour des performances accrues et une meilleure utilisation de la bande passante.



=== Création d'un cluster

*Un seul serveur*

. Lancez une invite PowerShell avec des autorisations administratives, en cliquant avec le bouton droit sur l'icône PowerShell et en sélectionnant `Run as Administrator`` .
. Créer un nouveau cluster.
+
[source, cli]
----
New-Cluster -Name <cluster_name> -Node <hostnames> -NoStorage -StaticAddress <cluster_ip_address>
----
+
image:hyperv-deploy-001.png["Image montrant l'interface de gestion des clusters"]

. Sélectionnez le réseau de cluster approprié pour la migration en direct.
. Désigner le réseau CSV.
+
[source, cli]
----
(Get-ClusterNetwork -Name Cluster).Metric = 900
----
. Modifiez le cluster pour utiliser un disque quorum.
+
.. Lancez une invite PowerShell avec des autorisations administratives en cliquant avec le bouton droit sur l'icône PowerShell et en sélectionnant « Exécuter en tant qu'administrateur ».
+
[source, cli]
----
start-ClusterGroup "Available Storage"| Move-ClusterGroup -Node $env:COMPUTERNAME
----
.. Dans le gestionnaire de cluster de basculement, sélectionnez `Configure Cluster Quorum Settings` .
+
image:hyperv-deploy-002.png["Image des paramètres de configuration du quorum du cluster"]

.. Cliquez sur Suivant sur la page d’accueil.
.. Sélectionnez le témoin du quorum et cliquez sur Suivant.
.. Sélectionnez « Configurer un témoin de disque » et cliquez sur Suivant.
.. Sélectionnez le disque W : dans le stockage disponible et cliquez sur Suivant.
.. Cliquez sur Suivant sur la page de confirmation et sur Terminer sur la page de résumé.
+
Pour des informations plus détaillées sur le quorum et le témoin, voirlink:https://learn.microsoft.com/en-us/windows-server/failover-clustering/manage-cluster-quorum#general-recommendations-for-quorum-configuration["Configuration et gestion du quorum"]



. Exécutez l’assistant de validation de cluster à partir du gestionnaire de cluster de basculement pour valider le déploiement.
. Créez un LUN CSV pour stocker les données de la machine virtuelle et créez des machines virtuelles hautement disponibles via des rôles dans Failover Cluster Manager.

