---
sidebar: sidebar 
permalink: migration/shift-toolkit-migrate-esxi2hyperv.html 
keywords: netapp, vmware, esxi, vm, migration, virtualization, hyper-v, microsoft 
summary: 'Migrez des machines virtuelles de VMware ESXi vers Microsoft Hyper-V à l"aide de Shift Toolkit en préparant les machines virtuelles, en convertissant les formats de disque et en configurant l"environnement cible.' 
---
= Migrez des machines virtuelles de VMware ESXi vers Microsoft Hyper-V à l'aide du kit d'outils Shift.
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Migrez des machines virtuelles de VMware ESXi vers Microsoft Hyper-V à l'aide de Shift Toolkit en préparant les machines virtuelles, en convertissant les formats de disque et en configurant l'environnement cible.

Le kit d'outils Shift permet la migration de machines virtuelles entre plateformes de virtualisation grâce à la conversion du format de disque et à la reconfiguration du réseau dans l'environnement de destination.



== Avant de commencer

Vérifiez que les conditions préalables suivantes sont remplies avant de commencer la migration.

.Exigences Hyper-V
* Hôtes Hyper-V configurés en tant qu'hôtes autonomes ou cluster de basculement
* Compte utilisateur Hyper-V avec privilèges d'administrateur
* Les hôtes Hyper-V sont accessibles via le réseau grâce à des entrées DNS à jour.
* Commutateurs virtuels configurés avec un réseau de jonction approprié
* Type de commutateur virtuel « Externe » pour la sélection du réseau
* Partage NFS (pour les machines virtuelles à convertir) et partage de destination (pour les machines virtuelles converties) sur le même volume
* Délégation SMB contrainte configurée à l'aide de `Enable-SmbDelegation` pour éviter les erreurs d'accès refusé
* SMB 3.0 activé (par défaut)
* Propriété disponible en permanence activée pour les actions PME
* Les stratégies d'exportation pour SMB sont désactivées sur la machine virtuelle de stockage (SVM).
+

NOTE: SCVMM n'est pas un point de terminaison pris en charge pour la migration dans la version actuelle.

* L'interface FCI Hyper-V et la découverte d'hôte reposent sur la résolution DNS. Assurez-vous que les noms d'hôtes sont résolubles depuis la machine virtuelle Shift Toolkit.  Si la résolution échoue, mettez à jour le fichier hôte.(`C:\Windows\System32\drivers\etc\hosts` ) et réessayez l'opération de découverte.


.Exigences VMware
* Les fichiers VMDK des machines virtuelles sont placés sur un volume NFSv3 (tous les fichiers VMDK d'une même machine virtuelle doivent se trouver sur le même volume).
* Les outils VMware sont exécutés sur des machines virtuelles invitées.
* Les machines virtuelles à migrer sont en état d'exécution en vue de leur préparation.
* Les machines virtuelles doivent être mises hors tension avant de déclencher la migration.
* La suppression des outils VMware s'effectue sur l'hyperviseur de destination une fois les machines virtuelles mises sous tension.


.Exigences relatives aux machines virtuelles invitées
* Pour les machines virtuelles Windows : utilisez les informations d’identification de l’administrateur local (les informations d’identification du domaine peuvent également être utilisées, mais assurez-vous qu’un profil utilisateur existe sur la machine virtuelle avant la conversion).
* Pour les machines virtuelles Linux : utilisez un utilisateur disposant des permissions nécessaires pour exécuter des commandes sudo sans invite de mot de passe (cet utilisateur doit figurer dans la liste des utilisateurs sudo ou y être ajouté). `/etc/sudoers.d/` dossier)




== Étape 1 : Ajouter le site de destination (Hyper-V)

Ajoutez l'environnement Hyper-V de destination à Shift Toolkit.

.Étapes
. Cliquez sur *Ajouter un nouveau site* et sélectionnez *Destination*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-307.png[Ajouter le site de destination]

====
. Saisissez les détails du site de destination :
+
** Nom du site : Veuillez indiquer un nom pour le site.
** Hyperviseur : sélectionnez Hyper-V comme cible
** *Emplacement du site* : Sélectionnez l’option par défaut
** *Connecteur* : Sélectionnez la sélection par défaut


. Cliquez sur *Continuer*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-308.png[Détails du site de destination]

====
. Saisissez les détails de destination Hyper-V :
+
** Gestionnaire de cluster Hyper-V autonome ou de basculement : adresse IP ou nom de domaine complet
** *Nom d'utilisateur* : Nom d'utilisateur permettant l'accès (au format UPN : nom_utilisateur@domaine.com ou domaine\administrateur)
** Mot de passe : Mot de passe permettant d’accéder à l’hôte Hyper-V ou à l’instance FCI pour effectuer l’inventaire des ressources.


. Sélectionnez *Accepter le certificat auto-signé* et cliquez sur *Continuer*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-309.png[Détails d'Hyper-V]

====
. Cliquez sur *Créer un site*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-310.png[Créer un site]

====
+

NOTE: Le système de stockage source et de destination doit être le même, car la conversion du format de disque se produit au niveau du volume et dans le même volume.





== Étape 2 : Créer des groupes de ressources

Organisez les machines virtuelles en groupes de ressources afin de préserver l'ordre de démarrage et les configurations de délai de démarrage.

.Avant de commencer
* Assurez-vous que les qtrees sont provisionnés conformément aux prérequis.
* Déplacez les machines virtuelles vers un datastore désigné sur une SVM ONTAP nouvellement créée avant la conversion afin d'isoler les datastores NFS de production de la zone de transit.


.Étapes
. Accédez à *Groupes de ressources* et cliquez sur *Créer un nouveau groupe de ressources*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-311.png[Créer un nouveau groupe de ressources]

====
. Sélectionnez le *site source* dans la liste déroulante et cliquez sur *Créer*.
. Fournissez les détails du groupe de ressources et sélectionnez le flux de travail :
+
** Migration par clonage : effectue une migration de bout en bout de l’hyperviseur source vers l’hyperviseur de destination.
** *Conversion basée sur le clonage* : Convertit le format du disque vers le type d’hyperviseur sélectionné
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-312.png[Détails du groupe de ressources]

====


. Cliquez sur *Continuer*.
. Sélectionnez les machines virtuelles à l'aide de l'option de recherche (le filtre par défaut est « Datastore »).
+

NOTE: La liste déroulante des banques de données n'affiche que les banques de données NFSv3.  Les banques de données NFSv4 ne sont pas affichées.

+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-313.png[sélection de VM]

====
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-314.png[Filtre de stockage de données]

====
. Détails de la migration mis à jour :
+
** Sélectionnez *Site de destination*
** Sélectionnez *Entrée Hyper-V de destination*
** Configurer le mappage Datastore vers Qtree
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-315.png[Détails de la migration]

====
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-316.png[Cartographie Qtree]

====
+

NOTE: Lors de la conversion de machines virtuelles d'ESXi vers Hyper-V, assurez-vous que le chemin de destination (où sont stockées les machines virtuelles converties) est défini sur un qtree. Plusieurs qtrees peuvent être créés et utilisés pour stocker les disques des machines virtuelles converties.



. Configurer l'ordre de démarrage et le délai de démarrage pour toutes les machines virtuelles sélectionnées :
+
** *1* : Première machine virtuelle à s'allumer
** *3* : Par défaut
** *5* : Dernière machine virtuelle à s'allumer
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-317.png[configuration de l'ordre de démarrage]

====


. Cliquez sur *Créer un groupe de ressources*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-318.png[Créer un groupe de ressources]

====


.Résultat
Le groupe de ressources est créé et prêt pour la configuration du plan.



== Étape 3 : Créer un plan de migration

Élaborez un plan directeur définissant la stratégie de migration, incluant les correspondances de plateformes, la configuration réseau et les paramètres des machines virtuelles.

.Étapes
. Accédez à *Plans* et cliquez sur *Créer un nouveau plan*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-319.png[Créer un nouveau plan]

====
. Indiquez un nom pour le modèle et configurez les mappages d'hôtes :
+
** Sélectionnez le *site source* et le vCenter associé.
** Sélectionnez le *site de destination* et la cible Hyper-V associée.
** Configurer le mappage du cluster et de l'hôte
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-320.png[Mappages d'hôtes]

====


. Sélectionnez les détails du groupe de ressources et cliquez sur *Continuer*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-321.png[Détails du groupe de ressources]

====
. Définissez l'ordre d'exécution des groupes de ressources s'il en existe plusieurs.
. Configurez le mappage réseau vers les commutateurs virtuels appropriés.
+

NOTE: Les commutateurs virtuels doivent déjà être configurés dans Hyper-V. Côté Hyper-V, seul le type de commutateur virtuel « Externe » est pris en charge pour la sélection du réseau.  Pour la migration de test, sélectionnez « Ne pas configurer le réseau » afin d'éviter les conflits avec le réseau de production ; attribuez manuellement les paramètres réseau après la conversion.

+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-322.png[Cartographie du réseau]

====
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-323.png[options de configuration réseau]

====
. Vérifier les mappages de stockage (sélectionnés automatiquement en fonction de la sélection de la machine virtuelle).
+

NOTE: Assurez-vous que le qtree est provisionné au préalable et que les autorisations nécessaires sont attribuées afin que la machine virtuelle puisse être créée et mise sous tension à partir d'un partage SMB.

. Configurez l'option de remplacement prepareVM si nécessaire.  Cette option est utile lorsque vous devez ignorer la préparation de la machine virtuelle par Shift Toolkit et effectuer ces tâches à la place à l'aide de scripts personnalisés.  Il permet également de personnaliser l'adresse IP afin de répondre aux exigences spécifiques de l'environnement.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-324.png[Remplacement de PrepareVM]

====
. Sous « Détails de la machine virtuelle », sélectionnez « Détails de configuration » et fournissez les informations d’identification du compte de service pour chaque type de système d’exploitation :
+
** *Windows* : Utilisez un utilisateur disposant de privilèges d’administrateur local (les informations d’identification de domaine peuvent également être utilisées, mais assurez-vous qu’un profil utilisateur existe sur la machine virtuelle avant la conversion).
** *Linux* : Utilisez un utilisateur pouvant exécuter des commandes sudo sans mot de passe (cet utilisateur doit figurer dans la liste des utilisateurs sudo ou y être ajouté). `/etc/sudoers.d/` dossier)
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-325.png[Informations d'identification VM]

====


. Configurer les paramètres IP :
+
** *Ne pas configurer* : Option par défaut
** *Conserver l'adresse IP* : Conserver les mêmes adresses IP que celles du système source
** *DHCP* : Attribuer un serveur DHCP aux machines virtuelles cibles
+
Assurez-vous que les machines virtuelles sont allumées pendant la phase prepareVM, que VMware Tools est installé et que les scripts de préparation s'exécutent avec les privilèges appropriés.



. Configurer les paramètres de la machine virtuelle :
+
** Redimensionner les paramètres du processeur/de la RAM (facultatif)
** Modifier l'ordre de démarrage et le délai de démarrage
** *Mise sous tension* : Sélectionnez cette option pour mettre les machines virtuelles sous tension après la migration (par défaut : activée).
** *Supprimer VMware Tools* : Supprimer VMware Tools après la conversion (par défaut : sélectionné)
** *Micrologiciel VM* : Gen1 > BIOS et Gen2 > EFI (automatique)
** *Conserver l'adresse MAC* : Conservez les adresses MAC pour les exigences de licence.
** *Remplacement du compte de service* : Spécifiez un compte de service distinct si nécessaire
** *Remplacement VLAN* : Sélectionner le nom de VLAN étiqueté correct lorsque l’hyperviseur cible utilise un nom de VLAN différent
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-326.png[Configuration VM]

====


. Cliquez sur *Continuer*.
. Planifiez la migration en sélectionnant une date et une heure.
+

NOTE: Planifiez les migrations au moins 30 minutes à l'avance pour laisser le temps nécessaire à la préparation des machines virtuelles.

+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-327.png[Migration planifiée]

====
. Cliquez sur *Créer un plan*.


.Résultat
Le Shift Toolkit lance une tâche prepareVM qui exécute des scripts sur les machines virtuelles sources afin de les préparer à la migration.

.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-328.png[tâche PrepareVM]

====
Le processus de préparation :

* Injecte des scripts pour ajouter des pilotes (RHEL/CentOS, Alma Linux), supprimer les outils VMware et sauvegarder les informations IP/route/DNS.
* Utilise invoke-VMScript pour se connecter aux machines virtuelles invitées et exécuter des tâches de préparation
* Pour les machines virtuelles Windows : stocke les scripts dans `C:\NetApp`
* Pour les machines virtuelles Linux : stocke les scripts dans `/NetApp` et `/opt`


.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-329.png[Scripts de préparation Windows]

====
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-330.png[Scripts de préparation Linux]

====

NOTE: Pour les machines virtuelles Linux exécutant CentOS ou Red Hat, Shift Toolkit installe automatiquement les pilotes Hyper-V nécessaires avant la conversion du disque afin de garantir un démarrage réussi après la conversion.  Pour plus d'informations, veuillez consulterlink:https://access.redhat.com/solutions/3465011["Système bloqué en dracut après la migration d'une VM RHEL vers hyper-v"] .

Une fois la préparation de la machine virtuelle terminée avec succès, l'état du modèle passe à « Actif ».  La migration aura désormais lieu à l'heure prévue ou peut être lancée manuellement en cliquant sur l'option *Migrer*.

.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-331.png[PréparationVM terminée]

====
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-332.png[Plan actif]

====


== Étape 4 : Exécuter la migration

Déclenchez le processus de migration pour convertir les machines virtuelles de VMware ESXi vers Microsoft Hyper-V.

.Avant de commencer
* Toutes les machines virtuelles sont arrêtées correctement conformément au calendrier de maintenance prévu.
* Assurez-vous que la machine virtuelle Shift fait partie du domaine
* Assurez-vous que le partage CIFS est configuré avec les autorisations appropriées
* L'arbre qtree utilisé pour la migration ou la conversion possède le style de sécurité approprié.
* Pour un test rapide, essayez de créer une machine virtuelle à l'aide du Gestionnaire Hyper-V depuis n'importe quel hôte Hyper-V du cluster et placez le disque dur virtuel (VHDX) sur le partage CIFS.


.Étapes
. Sur le plan, cliquez sur *Migrer*.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-333.png[Option de migration]

====
. Si les machines virtuelles ne sont pas éteintes, Shift Toolkit demandera un arrêt propre avant de poursuivre.
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-334.png[Invite d'arrêt]

====
. L'outil Shift Toolkit effectue les actions suivantes :
+
** Supprime les instantanés existants pour toutes les machines virtuelles du modèle.
** Déclenche des instantanés de machine virtuelle à la source
** Déclenche un instantané de volume avant la conversion du disque
** Convertit les fichiers VMDK au format VHDx pour toutes les machines virtuelles.
+
La conversion s'effectue en quelques secondes, ce qui en fait la méthode de migration la plus rapide et réduit les temps d'arrêt des machines virtuelles.

+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-335.png[Migration en cours]

====
+
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-336.png[Progression de la conversion]

====
** Met sous tension les machines virtuelles sur la cible
** Enregistre les réseaux sur chaque machine virtuelle
** Supprime les outils VMware et attribue des adresses IP à l'aide de scripts de déclenchement ou de tâches cron.




.Résultat
Une fois la tâche terminée, le statut du plan passe à « Migration terminée ».

.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-337.png[Migration terminée]

====
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-338.png[Machines virtuelles dans le Gestionnaire Hyper-V]

====
.Afficher un exemple
[%collapsible]
====
image::shift-toolkit-339.png[Détails de la machine virtuelle dans Hyper-V]

====

NOTE: Il ne faut pas déclencher plus de dix conversions en parallèle depuis la même source ESXi vers la même destination Hyper-V.


NOTE: S'il y a des échecs,link:https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/manage/remotely-manage-hyper-v-hosts["activer la délégation à l'aide de n'importe quel protocole d'authentification"] .


NOTE: Après la migration, lorsque les machines virtuelles Windows sont allumées, Shift Toolkit utilise PowerShell Direct pour se connecter aux machines virtuelles invitées sous Windows, indépendamment de la configuration réseau ou des paramètres de gestion à distance.


NOTE: Après la conversion, tous les disques de la VM sous Windows OS, à l'exception du disque du système d'exploitation, seront hors ligne car le paramètre NewDiskPolicy est défini par défaut sur offlineALL sur les VM VMware.  Exécutez cette commande PowerShell pour corriger : `Set-StorageSetting -NewDiskPolicy OnlineAll`


NOTE: Shift Toolkit utilise des tâches cron qui s'exécutent au démarrage pour les distributions Linux.  Aucune connexion SSH n'est créée pour les machines virtuelles Linux une fois qu'elles sont importées sur les hôtes Hyper-V.



== Démonstration vidéo

La vidéo suivante illustre le processus décrit dans cette solution.

.Migrer des machines virtuelles d'ESXi vers Hyper-V à l'aide de Shift Toolkit
video::f191dd7d-e4e4-4e5a-9654-b26400f3e9c4[panopto,width=360]